# PRD: Вкладка "Эволюция метрик" в плагине MetricsTree

## 1. Цели и задачи

- Позволить пользователю видеть, как изменялись ключевые метрики уровняпроекта по мере развития кода.
- Обеспечить визуальный анализ динамики метрик на уровне проекта для каждого коммита.
- Использовать метрики:
  - MHF,
    AHF,
    MIF,
    AIF,
    CF,
    PF,

## 2. Основные сценарии использования

- Пользователь открывает вкладку "Эволюция метрик" в плагине.
- На графике отображается динамика выбранных метрик по истории коммитов.
- Пользователь может выбрать интересующую метрику, навести курсор на точку и увидеть подробности о коммите.

## 3. Требования к функционалу

### 3.1 Источники данных

- История коммитов: через API плагина `git4idea`.
- Метрики: значения метрик уровня проекта для каждого коммита.

### 3.2 UI/UX

- Новая вкладка "Эволюция метрик" в окне плагина.
- График на основе `org.knowm.xchart`.
- Ось X: дата и сокращённый хеш коммита (`yyyy-MM-dd HH:mm (abcdef1)`).
- Ось Y: значения выбранной метрики.
- Легенда для нескольких метрик.
- Всплывающие подсказки с деталями коммита и метрики.
- Кнопка обновления данных.
- (Опционально) Экспорт графика.

### 3.3 Выбор метрик

- Возможность выбрать одну или несколько метрик для отображения.
- Переключение между метриками без перезагрузки вкладки.

### 3.4 Производительность

- Все долгие операции выполнять в фоне, UI не должен блокироваться.
- Использовать кэширование метрик, если возможно.

## 4. Архитектура и интеграция

- Использовать официальные API `git4idea` для получения истории коммитов.
- Для визуализации — `org.knowm.xchart`.
- Взаимодействие с существующим механизмом расчёта метрик.
- Код покрыт unit-тестами.

## 5. Технические требования

- Java 8+.
- Совместимость с IntelliJ Platform SDK.
- Использование официальных библиотек и API.

## 6. Пример визуализации

```
Y (метрика)
│
│        ●
│      ●
│    ●
│  ●
├─────────────────────────────→ X (дата, хеш)
  2025-04-10 (a1b2c3d) ... 2025-04-19 (d4e5f6g)
```

## 7. Используемые метрики уровня проекта

В рамках данной задачи для отображения на графике будут использоваться только метрики уровня проекта, определённые в классе `MetricType`:

- Halstead Volume (PRHVL)
- Halstead Difficulty (PRHD)
- Halstead Length (PRCHL)
- Halstead Effort (PRCHEF)
- Halstead Vocabulary (PRCHVC)
- Halstead Errors (PRCHER)
- Method Hiding Factor (MHF)
- Attribute Hiding Factor (AHF)
- Method Inheritance Factor (MIF)
- Attribute Inheritance Factor (AIF)
- Coupling Factor (CF)
- Polymorphism Factor (PF)
- Reusability
- Flexibility
- Understandability
- Functionality
- Extendibility
- Effectiveness
- Maintainability Index (PRMI)

**Только эти метрики будут доступны для выбора и визуализации на графике эволюции.**

## 8. Критерии готовности

- Вкладка появляется в интерфейсе.
- График корректно отображает историю метрик.
- Выбор метрик и обновление работают без ошибок.
- UI не блокируется при загрузке данных.
- Покрытие unit-тестами не менее 70%.

## 9. Декомпозиция задачи на подзадачи

1. **Добавить новую вкладку в UI плагина**  
   - Создать отдельную вкладку "Эволюция метрик" в окне плагина.
   - Отобразить placeholder для графика.

2. **Реализовать получение истории коммитов через git4idea**  
   - Использовать API git4idea для получения списка коммитов с датой, автором и сокращённым хешем.
   - Обеспечить корректную обработку больших репозиториев.

3. **Реализовать механизм сбора метрик для каждого коммита**  
   - Организовать вычисление или загрузку значений метрик уровня проекта для каждого коммита.
   - Использовать существующий механизм расчёта метрик (org.b333vv.metric.builder.ProjectMetricsSetCalculator)
   - Продумать кэширование результатов.

4. **Реализовать отображение графика на основе org.knowm.xchart**  
   - Построить базовый график с одной метрикой.
   - Отобразить значения по оси Y, дату и хеш по оси X.

5. **Добавить выбор метрик для отображения**  
   - Реализовать UI для выбора одной или нескольких метрик.
   - Обновлять график при изменении выбора.

6. **Добавить всплывающие подсказки и легенду**  
   - При наведении на точку показывать детали коммита и метрики.
   - Добавить легенду для нескольких метрик.

7. **Добавить кнопку обновления данных и обработку ошибок**  
   - Реализовать перезапуск сбора данных и пересчёт метрик.
   - Обеспечить обработку ошибок при получении истории или метрик.

8. **Обеспечить выполнение долгих операций в фоне**  
   - Вынести сбор истории и метрик в отдельные потоки.
   - UI не должен блокироваться.

9. **(Опционально) Реализовать экспорт графика**  
   - Добавить возможность сохранить график в PNG/SVG.

10. **Покрыть код unit-тестами**  
   - Добавить тесты для ключевых компонентов: получение истории, расчет метрик, построение графика.

---

Каждая подзадача рассчитана на выполнение Java-программистом уровня middle за 1 рабочий день.
